apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-platform-config
  namespace: kafka-platform
  labels:
    app.kubernetes.io/part-of: kafka-platform
data:
  # Kafka Broker
  KAFKA_NODE_ID: "1"
  KAFKA_BROKER_ID: "1"
  KAFKA_PROCESS_ROLES: "broker,controller"
  KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-broker-1.kafka-platform.svc.cluster.local:9094"
  KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:19092,CONTROLLER://0.0.0.0:9094,EXTERNAL://0.0.0.0:9092"
  KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-broker-1.kafka-platform.svc.cluster.local:9092,PLAINTEXT_INTERNAL://kafka-broker-1.kafka-platform.svc.cluster.local:19092,EXTERNAL://127.0.0.1:30092"
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT"
  KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
  KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT_INTERNAL"
  CLUSTER_ID: "EmptNWtoR4GGWx-BH6nGLQ"
  KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
  KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
  KAFKA_DEFAULT_REPLICATION_FACTOR: "1"
  KAFKA_MIN_INSYNC_REPLICAS: "1"

  # Schema Registry
  SCHEMA_REGISTRY_HOST_NAME: "schema-registry"
  SCHEMA_REGISTRY_LISTENERS: "http://0.0.0.0:8081"
  SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: "kafka-broker-1.kafka-platform.svc.cluster.local:19092"
  SCHEMA_REGISTRY_KAFKASTORE_SECURITY_PROTOCOL: "PLAINTEXT"

  # Kafka UI
  KAFKA_CLUSTERS_0_NAME: "local"
  KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka-broker-1.kafka-platform.svc.cluster.local:19092"
  KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: "PLAINTEXT"
  KAFKA_CLUSTERS_0_SCHEMAREGISTRY: "http://schema-registry.kafka-platform.svc.cluster.local:8081"
  DYNAMIC_CONFIG_ENABLED: "true"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-kraft-scripts
  namespace: kafka-platform
  labels:
    app.kubernetes.io/part-of: kafka-platform
data:
  kafka-kraft-start.sh: |
    #!/bin/bash
    set -e

    # First, generate the Kafka configuration
    echo "Generating Kafka configuration..."
    /etc/confluent/docker/configure

    # Check if storage has been formatted by looking for meta.properties
    if [ ! -f /var/lib/kafka/data/meta.properties ]; then
      echo "Storage not formatted. Formatting now..."
      kafka-storage format -t ${CLUSTER_ID} -c /etc/kafka/kafka.properties
      echo "Storage formatted successfully."
    else
      echo "Storage already formatted. Skipping format step."
    fi

    # Start Kafka
    echo "Starting Kafka broker..."
    /etc/confluent/docker/launch
